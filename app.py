import streamlit as st
import google.generativeai as genai
import plotly.express as px
import pandas as pd
import os

# 1. ุฅุนุฏุงุฏ ุงูุตูุญุฉ ูุชุตููููุง
st.set_page_config(
    page_title="ุงูููุตููู ุงููุถุงุฆู ุงูุขูู",
    page_icon="โ๏ธ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ุชูุณูู ุงููุงุฌูุฉ (CSS) ูุฏุนู ุงูุนุฑุจูุฉ ุจุดูู ููุชุงุฒ
st.markdown("""
<style>
    .main {direction: rtl;}
    .stTextInput, .stTextArea, .stSelectbox, .stCheckbox {text-align: right; direction: rtl;}
    div[data-testid="stMetricValue"] {font-size: 24px; color: #0ea5e9;}
    h1, h2, h3, h4, p, div {font-family: 'Tajawal', 'Arial', sans-serif;}
    .stAlert {direction: rtl;}
</style>
""", unsafe_allow_html=True)

# 2. ุงูุฅุนุฏุงุฏุงุช ูุงูุงุชุตุงู
api_key = os.environ.get("GOOGLE_API_KEY")
if not api_key:
    try:
        api_key = st.secrets["GOOGLE_API_KEY"]
    except:
        st.warning("โ๏ธ ุงูุฑุฌุงุก ูุถุน ููุชุงุญ API ูู Secrets")
        st.stop()

genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-1.5-flash")

# 3. ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/9203/9203720.png", width=60)
    st.title("ุงููุตูู ุงููุถุงุฆู")
    st.info("ุจูุงุจุฉ ุงููุฑุฒ ูุงูุชุฏููู ุงูุฐูู")
    
    selected_page = st.radio(
        "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
        ["ููุญุฉ ุงููุนูููุงุช", "ููุฏ ุฏุนูู ุฌุฏูุฏุฉ", "ุณุฌู ุงููุถุงูุง"],
        index=1 
    )
    st.markdown("---")
    st.caption("v2.0 - ูุชูุงูู ูุน ุงุดุชุฑุงุทุงุช ุงููุญุงูู")

# 4. ุตูุญุฉ ููุญุฉ ุงููุนูููุงุช
if selected_page == "ููุญุฉ ุงููุนูููุงุช":
    st.title("๐ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงููุถุงุฆู")
    col1, col2, col3, col4 = st.columns(4)
    col1.metric("ุฅุฌูุงูู ุงููุถุงูุง", "12", "+3")
    col2.metric("ูุถุงูุง ููุจููุฉ ุดููุงู", "8", "75%")
    col3.metric("ุจุญุงุฌุฉ ูุงุณุชููุงู", "4", "-2")
    col4.metric("ุฒูู ุงูุชุฏููู ุงูุขูู", "0.8 ุซ", "ููุฑู")
    
    st.markdown("---")
    col_chart1, col_chart2 = st.columns(2)
    with col_chart1:
        st.subheader("ุชูุฒูุน ุงููุถุงูุง ุญุณุจ ุงูุงุฎุชุตุงุต")
        data = pd.DataFrame({'ุงููุญููุฉ': ['ุชุฌุงุฑูุฉ', 'ุฃุญูุงู ุดุฎุตูุฉ', 'ุนูุงููุฉ', 'ุนุงูุฉ'], 'ุงูุนุฏุฏ': [40, 30, 20, 10]})
        fig = px.pie(data, values='ุงูุนุฏุฏ', names='ุงููุญููุฉ', hole=0.4, color_discrete_sequence=px.colors.sequential.Blues)
        st.plotly_chart(fig, use_container_width=True)
    with col_chart2:
        st.subheader("ุฃุณุจุงุจ ุนุฏู ุงููุจูู ุงูุดููู")
        data_err = pd.DataFrame({'ุงูุณุจุจ': ['ููุต ุงููุณุชูุฏุงุช', 'ุนุฏู ุชุญุฑูุฑ ุงูุฏุนูู', 'ุนุฏู ุณุฏุงุฏ ุงูุฑุณูู', 'ุฃุฎุฑู'], 'ุงูุนุฏุฏ': [15, 12, 5, 2]})
        fig2 = px.bar(data_err, x='ุงูุนุฏุฏ', y='ุงูุณุจุจ', orientation='h', color_discrete_sequence=['#0ea5e9'])
        st.plotly_chart(fig2, use_container_width=True)

# 5. ุตูุญุฉ ููุฏ ุฏุนูู ุฌุฏูุฏุฉ (ุงูุฌููุฑ)
elif selected_page == "ููุฏ ุฏุนูู ุฌุฏูุฏุฉ":
    st.title("๐ ููุฏ ูุชุฏููู ุตุญููุฉ ุงูุฏุนูู")
    st.markdown("ูููู ุงููุธุงู ุจูุฑุงุฌุนุฉ ุตุญููุฉ ุงูุฏุนูู ููุชุฃูุฏ ูู ุงุณุชููุงุฆูุง ููุชุทูุจุงุช ุงููุจูู ูู ุงููุญุงูู ุงูุณุนูุฏูุฉ.")
    
    with st.container():
        col_input, col_result = st.columns([1.3, 1])
        
        with col_input:
            with st.form("case_form"):
                st.subheader("1. ุจูุงูุงุช ุงูุตุญููุฉ")
                col_a, col_b = st.columns(2)
                with col_a:
                    plaintiff = st.text_input("ุจูุงูุงุช ุงููุฏุนู (ุงูุงุณู/ุงูุตูุฉ)")
                with col_b:
                    defendant = st.text_input("ุจูุงูุงุช ุงููุฏุนู ุนููู")
                
                subject = st.text_input("ููุถูุน ุงูุฏุนูู (ุงูุนููุงู)")
                
                st.markdown("**ุชูุงุตูู ุงูุฏุนูู (ุงูููุงุฆุน - ุงูุทูุจุงุช - ุงูุฃุณุงููุฏ):**")
                lawsuit_text = st.text_area("ูุต ุงูุตุญููุฉ", height=250, placeholder="ุงูุชุจ ููุง ููุงุฆุน ุงูุฏุนูู ูุทูุจุงุชู ุจูุถูุญ...")
                
                st.markdown("---")
                st.subheader("2. ูุชุทูุจุงุช ุงููุจูู")
                check_docs = st.checkbox("ุชู ุฅุฑูุงู ุงููุณุชูุฏุงุช ุงูุฏุงุนูุฉ (ุงูุนููุฏ/ุงููููุฉ/ุงูููุงูุฉ)")
                check_fees = st.checkbox("ุชู ุณุฏุงุฏ ุงูุฑุณูู ุงููุถุงุฆูุฉ (ุฅู ูุฌุฏุช)")
                
                submitted = st.form_submit_button("๐ ุชุฏููู ูููุฏ ุงูุฏุนูู", type="primary")
        
        with col_result:
            if submitted:
                if not lawsuit_text or not plaintiff or not defendant:
                    st.warning("โ๏ธ ุงูุฑุฌุงุก ุชุนุจุฆุฉ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ (ุงูุฃุทุฑุงู ููุต ุงูุฏุนูู).")
                else:
                    with st.spinner('ุฌุงุฑู ุงุณุชุดุงุฑุฉ ุงููุฏูู ุงูุขูู...'):
                        try:
                            # Prompt ูุญุฏุซ ูุดูู ุงููุชุทูุจุงุช ุงูุฌุฏูุฏุฉ
                            prompt = f"""
                            ุจุตูุชู ูุฏููุงู ูุถุงุฆูุงู ุฎุจูุฑุงู ูู ุงููุญุงูู ุงูุณุนูุฏูุฉุ ูู ุจูุฑุงุฌุนุฉ ุตุญููุฉ ุงูุฏุนูู ุงูุชุงููุฉ.
                            
                            ุงูุจูุงูุงุช ุงููุฏุฎูุฉ:
                            - ุงููุฏุนู: {plaintiff}
                            - ุงููุฏุนู ุนููู: {defendant}
                            - ูู ุชู ุชุฃููุฏ ุงููุฑููุงุชุ: {"ูุนู" if check_docs else "ูุง"}
                            - ูู ุชู ุชุฃููุฏ ุงูุฑุณููุ: {"ูุนู" if check_fees else "ูุง"}
                            - ูุต ุงูุฏุนูู: "{lawsuit_text}"

                            ุงููุทููุจ ููู (ุงูุชุญูู ูุงูุชุฏููู):
                            1. **ุงููุบุฉ:** ูู ุงููุต ููุชูุจ ุจูุบุฉ ุนุฑุจูุฉ ูุงุถุญุฉุ
                            2. **ุงูุงุฎุชุตุงุต:** ุญุฏุฏ ุงููุญููุฉ ุงููุฎุชุตุฉ ููุนูุงู ูููุงููุงู (ุจูุงุกู ุนูู ุงูุณูุงู).
                            3. **ุชุญุฑูุฑ ุงูุฏุนูู:** ูู ุงูููุงุฆุน ูุงูุทูุจุงุช ูุงูุฃุณุงููุฏ ูุฐููุฑุฉ ุจูุถูุญุ
                            4. **ุงููุชุทูุจุงุช ุงูุฅุฏุงุฑูุฉ:** ุนููู ุนูู ุญุงูุฉ ุงููุฑููุงุช ูุงูุฑุณูู ุจูุงุกู ุนูู ูุฏุฎูุงุช ุงููุณุชุฎุฏู.

                            ุงููุฎุฑุฌุงุช (ุจุชูุณูู Markdown ุฃููู):
                            ---
                            ### ๐ ุชูุฑูุฑ ุงููุจูู ุงูุดููู
                            
                            #### 1. ุงูุชุตููู ูุงูุชูุฌูู
                            * **ุงููุญููุฉ ุงููุฎุชุตุฉ:** [ุงุณู ุงููุญููุฉ]
                            * **ุฏุฑุฌุฉ ุงูุงุณุชุนุฌุงู:** [ุนุงุฏูุฉ/ูุณุชุนุฌูุฉ]
                            
                            #### 2. ูุงุฆูุฉ ุงูุชุญูู ูู ุงููุชุทูุจุงุช
                            * [ ] **ูุบุฉ ุงูุตุญููุฉ:** [ููุจููุฉ/ุบูุฑ ููุจููุฉ]
                            * [ ] **ุชุญุฑูุฑ ุงูุฏุนูู (ุงูููุงุฆุน ูุงูุทูุจุงุช):** [ููุชููุฉ/ูุงูุตุฉ] - *ูุน ุดุฑุญ ููุฌุฒ*
                            * [ ] **ุงููุณุชูุฏุงุช ูุงููุฑููุงุช:** {"โ ุชู ุงูุชุฃููุฏ" if check_docs else "โ ูู ูุชู ุงูุชุฃููุฏ (ูุทููุจ)"}
                            * [ ] **ุงูุฑุณูู ุงููุถุงุฆูุฉ:** {"โ ุชู ุงูุชุฃููุฏ" if check_fees else "โ๏ธ ุชุฐููุฑ ุจุงูุณุฏุงุฏ"}
                            
                            #### 3. ุงููุฑุงุฑ ูุงูุชูุตูุฉ
                            * **ุงูุญุงูุฉ:** [ููุจููุฉ ุดููุงู / ุชุชุทูุจ ุชุนุฏูู]
                            * **ุงูุชูุตูุฉ:** (ุงูุชุจ ูุตูุญุฉ ูููุฏุนู ูุฅููุงู ุงูููุงูุต ุฃู ุชุญุณูู ุงูุตูุงุบุฉุ ูุฐูุฑู ุจุถุฑูุฑุฉ ูุฌูุฏ ููุงูุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ).
                            """
                            
                            response = model.generate_content(prompt)
                            
                            st.success("ุชูุช ุงููุนุงูุฌุฉ!")
                            st.markdown(f"""
                            <div style="background-color: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                {response.text}
                            </div>
                            """, unsafe_allow_html=True)
                            
                        except Exception as e:
                            st.error(f"ุญุฏุซ ุฎุทุฃ: {e}")
            else:
                st.info("๐ ูู ุจุชุนุจุฆุฉ ุงููููุฐุฌ ูุงุถุบุท ุนูู ุฒุฑ ุงูุชุฏููู")

# 6. ุตูุญุฉ ุงูุณุฌู
elif selected_page == "ุณุฌู ุงููุถุงูุง":
    st.title("๐๏ธ ุงูุฃุฑุดูู ุงููุถุงุฆู")
    df = pd.DataFrame({
        "ุฑูู ุงูููุฏ": ["4401", "4402", "4403"],
        "ุชุงุฑูุฎ ุงูุชูุฏูู": ["2024-01-20", "2024-01-21", "2024-01-22"],
        "ุงููุฏุนู": ["ุดุฑูุฉ ุงูุฃูู", "ูุญูุฏ ุงูุนุชูุจู", "ูุคุณุณุฉ ุงูุจูุงุก"],
        "ุญุงูุฉ ุงูุชุฏููู": ["โ ููุจููุฉ", "โ ูุฑููุถุฉ (ููุต ุจูุงูุงุช)", "โ ููุจููุฉ"]
    })
    st.table(df)
